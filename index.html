<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Editor TTD - Galactic Edition</title>
  
  <!-- Library Inti -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import * as pdfjsLib from "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.mjs";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

  <!-- STYLE TEMA (Digabungkan) -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }

    /* --- SISTEM TEMA --- */
    :root {
      --accent-purple-start: #a855f7; --accent-purple-end: #d946ef;
      --accent-blue-start: #3b82f6; --accent-blue-end: #60a5fa;
      --accent-emerald-start: #10b981; --accent-emerald-end: #34d399;
      --accent-rose-start: #f43f5e; --accent-rose-end: #fb7185;
      
      --accent-start: var(--accent-purple-start);
      --accent-end: var(--accent-purple-end);
      
      --bg-color: #111827; --card-color: #1f2937; --border-color: #374151;
      --text-primary: #f9fafb; --text-secondary: #9ca3af;
      --header-bg: rgba(17, 24, 39, 0.7); --sidebar-bg: rgba(17, 24, 39, 0.5);
      --input-bg: #1f2937; --button-secondary-bg: #1f2937;
    }
    
    body.light-theme {
      --bg-color: #f9fafb; --card-color: #ffffff; --border-color: #e5e7eb;
      --text-primary: #111827; --text-secondary: #6b7280;
      --header-bg: rgba(255, 255, 255, 0.7); --sidebar-bg: rgba(249, 250, 251, 0.5);
      --input-bg: #f3f4f6; --button-secondary-bg: #f3f4f6;
    }
    
    body { 
      background-color: var(--bg-color); 
      color: var(--text-primary); 
      transition: background-color 0.3s ease, color 0.3s ease; 
      /* PERUBAHAN: Hapus overflow: hidden; agar main content bisa scroll */
    }
    
    /* --- EFEK VISUAL --- */
    #constellation-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    #spotlight { position: fixed; width: 400px; height: 400px; border-radius: 50%; background: radial-gradient(circle, oklch(from var(--accent-start) l c h / 15%), transparent 60%); transform: translate(-50%, -50%); pointer-events: none; z-index: 0; transition: width 0.3s, height 0.3s; }
    body.light-theme #spotlight { background: radial-gradient(circle, oklch(from var(--accent-start) l c h / 5%), transparent 60%); }

    /* --- ANIMASI & UTILITAS TAMPILAN BARU --- */
    .initial-hidden { opacity: 0; transform: translateY(20px); }
    .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .drag-over-active { border-color: var(--accent-start) !important; background-color: oklch(from var(--accent-start) l c h / 5%); }
    .pulsing-border { animation: pulse 4s infinite ease-in-out; }
    @keyframes pulse { 0%, 100% { border-color: var(--border-color); } 50% { border-color: var(--accent-start); } }
    .shimmer-button { position: relative; overflow: hidden; }
    .shimmer-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s ease; }
    .shimmer-button:hover::before { left: 150%; }
    .spinner { width: 20px; height: 20px; border-radius: 50%; display: inline-block; border-top: 2px solid #fff; border-right: 2px solid transparent; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- TOAST & MODAL --- */
    .toast { color: var(--text-primary); background: var(--card-color); backdrop-filter: blur(10px); border: 1px solid var(--border-color); box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.4); position: fixed; bottom: 20px; left: 50%; z-index: 1000; padding: 0.75rem 1.25rem; border-radius: 0.5rem; opacity: 0; transform: translate(-50%, 100%); transition: all 0.5s cubic-bezier(0.21, 1.02, 0.73, 1); }
    .toast.show { opacity: 1; transform: translate(-50%, 0); }
    .modal-container.hidden { pointer-events: none; }
    #settings-overlay, #ji-confirm-overlay { transition: opacity 0.3s ease-in-out; }
    #settings-modal-content, #ji-confirm-modal-content { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }

    /* --- STYLE EDITOR (Digabungkan & Disesuaikan) --- */

    /* Area Preview PDF (dari file lama) */
    .pdf-main {
      flex: 1;
      overflow: auto;
      display: flex;
      justify-content: center;
      padding: 20px 0;
      /* PERUBAHAN: Hapus height 100vh, biarkan flex-1 yg mengatur */
    }
    .pdf-pages-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
      transform-origin: top center;
    }
    .preview-container {
      position: relative;
      background: #fff;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transform-origin: 0 0;
    }
    
    /* PERUBAHAN: Hapus style .sidebar, karena kita pakai <aside> */

    /* Tombol Pengaturan Tema di Sidebar */
    #settings-button-editor {
      position: absolute;
      top: 1.25rem;
      right: 1.25rem;
      padding: 0.5rem;
      border-radius: 9999px;
      transition: all 0.3s ease;
      color: var(--text-secondary);
    }
    #settings-button-editor:hover {
      background-color: var(--border-color);
      transform: rotate(45deg);
    }

    /* Elemen Interaktif (TTD, shape, teks) - (dari file lama) */
    .stamp-container, .shape-element, .text-element {
      position: absolute;
      cursor: move;
      user-select: none;
      z-index: 5;
    }
    .stamp-container, .shape-element { border: 1px dashed var(--accent-start); }
    .stamp-container { z-index: 15; }
    .stamp-container img {
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: none;
      /* BARU: Pastikan TTD tidak gepeng di thumbnail */
      object-fit: contain; 
    }
    .text-element {
      background-color: transparent;
      font-size: 16px;
      color: #000;
      transform-origin: top left;
      line-height: 1;
      z-index: 9999;
      white-space: pre-wrap;
      text-align: left;
      padding: 2px;
      transition: background-color 0.2s;
    }
    .text-element[contenteditable="true"] {
      background-color: rgba(255, 255, 255, 0.8);
      color: #000 !important;
      outline: 1px dashed var(--accent-start);
    }
    .stamp-selected { outline: 2px dashed var(--accent-start); }
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent-start);
      right: -1px;
      bottom: -1px;
      cursor: se-resize;
      z-index: 20;
      pointer-events: all;
      border-radius: 2px 0 0 0;
    }
    .stamp-delete-button {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      background: var(--accent-rose-start);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 25;
      font-size: 14px;
      line-height: 18px;
      padding: 0;
      transition: transform 0.2s ease;
    }
    .stamp-delete-button:hover { transform: scale(1.1); }
    
    /* Timestamp Preview (dari file lama) */
    .timestamp-preview {
      position: absolute;
      font-size: 8px;
      color: #000000;
      cursor: move;
      z-index: 1000;
      padding: 2px 5px;
      background-color: rgba(255, 255, 0, 0.5);
      border-radius: 3px;
    }
    
    /* PERUBAHAN: Tombol Tambah/Hapus File PDF (Dihapus) */
    
    /* Formatting Section (dari file lama) */
    .formatting-section {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
      color: var(--text-primary);
    }
    .formatting-section h3 {
      margin-bottom: 8px;
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-start);
    }
    #text-formatting-section { display: none; }
    #shapes-header.collapsed #shapes-chevron { transform: rotate(-90deg); }
    
    /* Styling untuk Input, Select, Button (Disesuaikan agar berlaku di <aside>) */
    aside input[type="file"] {
      color: var(--text-secondary);
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      padding: 0.5rem;
    }
    aside input[type="file"]::file-selector-button {
      background-color: var(--button-secondary-bg);
      color: var(--text-primary);
      border: 0;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      margin-right: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    aside input[type="file"]::file-selector-button:hover {
      background-color: var(--border-color);
    }

    aside select,
    aside input[type="color"],
    aside input[type="number"],
    aside input[type="text"] {
      width: 100%;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--text-primary);
    }
    aside input[type="color"] {
      padding: 2px;
      height: 40px;
    }

    /* Tombol Format Teks & Shape */
    .formatting-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .formatting-buttons button, .shape-btn {
      padding: 6px 8px;
      font-weight: bold;
      min-width: 32px;
      background: var(--button-secondary-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .formatting-buttons button:hover, .shape-btn:hover { 
      background-color: var(--border-color); 
    }
    .formatting-buttons button.active-btn, .shape-btn.active-btn {
      background-image: linear-gradient(to right, var(--accent-start), var(--accent-end));
      color: #fff;
    }
    
    /* Tombol Aksi (Add Shape, Download) */
    .action-button {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      transition: all 0.3s;
      cursor: pointer;
    }
    .action-button-primary {
      background-image: linear-gradient(to right, var(--accent-start), var(--accent-end));
    }
    .action-button-primary:hover {
      filter: brightness(1.1);
    }
    .action-button-secondary {
      background-color: var(--button-secondary-bg);
      color: var(--text-primary);
    }
    .action-button-secondary:hover {
      background-color: var(--border-color);
    }
    .signature-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .signature-thumb {
      width: 60px;
      height: 60px;
      border: 2px solid var(--border-color);
      cursor: pointer;
      object-fit: contain;
      border-radius: 4px;
      transition: border-color 0.2s;
    }
    .signature-thumb:hover, .signature-thumb-active {
      border-color: var(--accent-start);
    }
    
    /* --- STYLE BARU UNTUK SIDEBAR DARI FILE V1.5 --- */
    #signature-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
        max-height: 200px; /* Batas tinggi agar bisa scroll */
        overflow-y: auto;
    }
    .sig-thumbnail-wrapper {
        position: relative;
        border: 2px dashed var(--border-color);
        border-radius: 0.25rem;
        padding: 0.25rem;
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--button-secondary-bg);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .sig-thumbnail-wrapper:hover {
        border-color: var(--accent-start);
        background-color: var(--card-color);
    }
    .sig-thumbnail-wrapper.signature-thumb-active { /* Ganti nama dari file lama */
        border-color: var(--accent-start);
    }
    .sig-thumbnail {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .sig-thumbnail-delete {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent-rose-start);
        color: white;
        border: 1px solid var(--bg-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        opacity: 0.8;
        transition: all 0.2s ease;
        z-index: 10;
    }
    .sig-thumbnail-delete:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    #timestamp-controls {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 0.5rem;
    }
    .timestamp-btn {
        padding: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.375rem;
        border: 1px solid var(--border-color);
        background-color: var(--button-secondary-bg);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .timestamp-btn:hover {
        border-color: var(--accent-start);
        color: var(--text-primary);
    }
    .timestamp-btn.active-timestamp {
        background-color: var(--accent-start);
        border-color: var(--accent-end);
        color: white;
        box-shadow: 0 0 10px oklch(from var(--accent-start) l c h / 50%);
    }
    
    /* PERBAIKAN: Style untuk Scrollbar Sidebar */
    .sidebar-content-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .sidebar-content-scroll::-webkit-scrollbar-thumb {
      background-color: var(--border-color);
      border-radius: 3px;
    }
    .sidebar-content-scroll::-webkit-scrollbar-thumb:hover {
      background-color: var(--text-secondary);
    }
    .sidebar-content-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    /* --- AKHIR STYLE BARU --- */

    /* Custom Context Menu */
    .custom-context-menu {
      position: absolute;
      z-index: 2000;
      background: var(--card-color);
      border: 1px solid var(--border-color);
      box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
      padding: 5px 0;
      display: none;
      border-radius: 6px;
    }
    .custom-context-menu ul { list-style: none; margin: 0; padding: 0; }
    .custom-context-menu li {
      padding: 8px 15px;
      cursor: pointer;
      color: var(--text-primary);
    }
    .custom-context-menu li:hover { background-color: var(--border-color); }
    
    /* Toolbar Fixed (Disesuaikan) */
    .pdf-controls {
      position: fixed;
      bottom: 20px;
      left: 50%; /* Mobile first */
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: none; /* PERBAIKAN: Sembunyikan by default */
    }
    @media (min-width: 1024px) { /* lg breakpoint */
      .pdf-controls {
        /* 192px = 384px / 2 = 24rem / 2 */
        left: calc(50% - 192px); 
      }
    }
    .pdf-controls button {
      background-image: linear-gradient(to right, var(--accent-start), var(--accent-end));
      color: #fff;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 6px;
      cursor: pointer;
      transition: filter 0.2s;
    }
    .pdf-controls button:hover { filter: brightness(1.1); }
    .pdf-controls button.gray-btn {
      background: var(--button-secondary-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .pdf-controls button.gray-btn:hover {
      background: var(--border-color);
    }
    .pdf-controls button.active-btn {
      filter: brightness(1.2);
      box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px var(--accent-end);
    }
    .pdf-controls input[type="number"] {
      width: 60px;
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px 4px;
      background: var(--input-bg);
      color: var(--text-primary);
    }
  </style>
</head>
<body class="antialiased">

<!-- EFEK VISUAL -->
<canvas id="constellation-canvas"></canvas>
<div id="spotlight"></div>

<!-- PERUBAHAN: Header Baru -->
<header class="backdrop-blur-md shadow-sm sticky top-0 z-40 border-b initial-hidden" style="background-color: var(--header-bg); border-color: var(--border-color);">
    <div class="flex items-center justify-between px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center space-x-3">
            <img id="app-icon" src="https://ajmaerlangga.github.io/image/icon_merge_purple.png" class="h-8 w-8" alt="App Icon">
            <!-- Judul dari file lama -->
            <h1 class="text-2xl font-bold">PDF Editor TTD</h1>
        </div>
        <!-- Tombol Settings diganti ke ID dari file lama agar JS-nya berfungsi -->
        <button id="settings-button-editor" class="p-2 rounded-full transition-all duration-300 hover:rotate-45" style="color: var(--text-secondary); background-color: transparent;" onmouseover="this.style.backgroundColor='var(--border-color)'" onmouseout="this.style.backgroundColor='transparent'"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
    </div>
</header>

<!-- PERUBAHAN: Layout Utama Baru (Main + Aside) -->
<div class="flex flex-col lg:flex-row h-[calc(100vh-68px)]">
  
  <!-- Konten Utama (Preview PDF) -->
  <main id="main-content" class="flex flex-col flex-1 p-4 sm:p-6 lg:p-8 transition-all duration-300 initial-hidden overflow-y-auto" style="animation-delay: 0.2s;">
      
      <!-- Dropzone (Awal) - dari file baru -->
      <div id="dropzone" class="col-span-full flex flex-col items-center justify-center h-full rounded-xl border-2 border-dashed p-12 text-center transition-all duration-300 pulsing-border" style="border-color: var(--border-color);">
          <img id="dropzone-icon" src="https://ajmaerlangga.github.io/image/icon_merge_purple.png" class="h-20 w-20 mb-4" alt="Dropzone Icon">
          <h3 class="text-2xl font-semibold">Drag & Drop PDF Anda ke Sini</h3>
          <p class="mt-2" style="color: var(--text-secondary);">atau</p>
          <button onclick="triggerFileInput()" class="shimmer-button mt-4 text-white px-6 py-2 rounded-lg transition-all duration-300 font-semibold shadow-md active:scale-95" style="background-image: linear-gradient(to right, var(--accent-start), var(--accent-end));">Pilih File</button>
      </div>

      <!-- Preview Area (Setelah file di-upload) - dari file baru -->
      <div id="preview-section" class="hidden flex-grow flex flex-col h-full overflow-hidden">
          <!-- Konten PDF (dari file lama) dipindahkan ke sini -->
          <div class="pdf-main">
            <div class="pdf-pages-wrapper" id="pdf-pages-wrapper"></div>
          </div>
      </div>

  </main>

  <!-- Sidebar (Kontrol) - dari file baru -->
  <!-- DIMODIFIKASI: Seluruh <aside> diganti dengan kode dari V1.5, dengan penyesuaian -->
  <aside class="w-full lg:w-96 backdrop-blur-md p-6 flex flex-col border-l initial-hidden h-full overflow-hidden" style="background-color: var(--sidebar-bg); border-color: var(--border-color); animation-delay: 0.4s;">
    
      <!-- Wrapper flex-grow agar bagian download ke bawah -->
      <!-- PERBAIKAN: Tambah overflow-y-auto dan class scrollbar -->
      <div class="flex flex-col flex-grow min-h-0 space-y-4 overflow-y-auto sidebar-content-scroll">
          
          <!-- Input File PDF (tersembunyi, dari tes.html asli) -->
          <input type="file" id="pdf-file" accept="application/pdf" class="hidden" />
          <!-- Input TTD (tersembunyi, dari tes.html asli, ditambah 'multiple') -->
          <input type="file" id="sig-file" accept="image/png, image/jpeg" class="hidden" multiple />
          
          <!-- Konten Sidebar (DARI V1.5) -->
          <h3 class="text-sm font-semibold mb-2 uppercase tracking-wider" style="color: var(--text-secondary);">Galeri Tanda Tangan</h3>
                
          <button id="upload-signature-btn" onclick="triggerSignatureUpload()" class="shimmer-button w-full px-4 py-2 rounded-lg transition-all duration-300 flex items-center justify-center font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 active:scale-95" style="background-color: var(--button-secondary-bg); color: var(--text-primary); --tw-ring-offset-color: var(--bg-color); --tw-ring-color: var(--accent-start);">
              <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
              Unggah Gambar TTD
          </button>

          <!-- max-h agar galeri bisa scroll internal -->
          <div id="signature-gallery" class="mt-4 overflow-y-auto">
              <!-- Thumbnail TTD akan dirender oleh JS di sini -->
          </div>
          
          <!-- Timestamp (DARI V1.5) -->
          <div class="mt-4 pt-4 border-t" style="border-color: var(--border-color);">
              <h3 class="text-sm font-semibold mb-2 uppercase tracking-wider" style="color: var(--text-secondary);">Timestamp (Teks)</h3>
              <!-- Select Asli (disembunyikan) untuk menampung state -->
              <select id="user" class="hidden">
                <option value="0">--Pilih--</option>
                <option value="sss">Sales Support</option>
                <option value="sales">Sales</option>
              </select>
              <!-- Tombol V1.5 (terlihat) -->
              <div id="timestamp-controls">
                  <button class="timestamp-btn" data-type="SSS">SSS</button>
                  <button class="timestamp-btn" data-type="SALES">SALES</button>
                  <button class="timestamp-btn" data-type="NONE">Nonaktif</button>
              </div>
          </div>
          
          <!-- Fitur Asli (Shapes & Teks) dari tes.html -->
          <!-- PERBAIKAN: Tampilan Shapes di-update -->
          <div class="mt-4"> <!-- Hapus formatting-section dari wrapper -->
            <h3 class="flex justify-between items-center cursor-pointer collapsed p-3 rounded-lg" id="shapes-header" style="background-color: var(--button-secondary-bg); border: 1px solid var(--border-color);">
              <span class="text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Shapes</span>
              <i id="shapes-chevron" class="fas fa-chevron-down transition-transform duration-200" style="color: var(--text-secondary);"></i>
            </h3>
            <div id="shapes-content" style="display: none;" class="formatting-section mt-2"> <!-- Pindahkan formatting-section ke sini -->
              <label class="block font-medium mb-1 text-sm" style="color: var(--text-secondary);">Tipe Shape:</label> <!-- Hapus mt-2 -->
              <div id="shape-buttons" class="flex gap-2">
                <button type="button" class="shape-btn active-btn" data-shape="rectangle" title="Rectangle"><i class="fas fa-square"></i></button>
                <button type="button" class="shape-btn" data-shape="ellipse" title="Ellipse"><i class="fas fa-circle"></i></button>
                <button type="button" class="shape-btn" data-shape="line" title="Line"><i class="fas fa-minus"></i></button>
              </div>
              <label class="block font-medium mb-1 text-sm mt-2" style="color: var(--text-secondary);">Warna Shape:</label>
              <input type="color" id="shape-color" value="#f43f5e">
              <button id="btnToggleShape" class="action-button action-button-secondary mt-2">Add Shape</button>
            </div>
          </div>
          
          <!-- Format Teks (dari tes.html) -->
          <div class="formatting-section" id="text-formatting-section">
            <!-- PERBAIKAN: h3 di-style ulang agar konsisten -->
            <h3 class="text-sm font-semibold uppercase tracking-wider mb-2" style="color: var(--accent-start);">Format Teks</h3>
            <div class="mb-2">
              <label class="text-sm" style="color: var(--text-secondary);">Jenis Font:</label>
              <select id="font-family">
                <option value="Helvetica">Helvetica</option>
                <option value="Times Roman">Times Roman</option>
                <option value="Courier">Courier</option>
                <option value="Verdana">Verdana</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="text-sm" style="color: var(--text-secondary);">Ukuran Font:</label>
              <input type="number" id="font-size" value="12" min="1" />
            </div>
            <div class="mb-2">
              <label class="text-sm" style="color: var(--text-secondary);">Warna Teks:</label>
              <input type="color" id="font-color" value="#000000">
            </div>
            <div class="formatting-buttons">
              <button id="btn-bold">B</button>
              <button id="btn-italic">I</button>
              <button id="btn-underline">U</button>
              <button id="btn-align-left"><i class="fas fa-align-left"></i></button>
              <button id="btn-align-center"><i class="fas fa-align-center"></i></button>
              <button id="btn-align-right"><i class="fas fa-align-right"></i></button>
            </div>
          </div>
      </div>
      
      <!-- Bagian Download (dari V1.5, disesuaikan) -->
      <div class="mt-6 pt-6 border-t" style="border-color: var(--border-color);">
          <div class="mb-3"> <!-- Disesuaikan dari V1.5 -->
            <label class="block text-sm font-medium" style="color: var(--text-secondary);">Nama Output PDF:</label>
            <input type="text" id="outputFileName" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm placeholder-gray-500 focus:outline-none focus:ring-2 sm:text-sm" style="background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--accent-start);" placeholder="Modified_PDF">
          </div>
          
          <button id="btnDownload" class="action-button action-button-primary shimmer-button w-full py-3"> <!-- Disesuaikan dari V1.5 -->
            <span id="mergeButtonText">Unduh PDF</span>
            <div id="mergeSpinner" class="spinner ml-2 hidden"></div>
          </button>
          
          <!-- Tombol Ganti/Hapus File (dari V1.5) -->
          <div class="flex items-center space-x-3 mt-4">
              <button onclick="triggerFileInput()" class="shimmer-button flex-1 px-4 py-2 rounded-lg transition-all duration-300 flex items-center justify-center font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 active:scale-95 hover:-translate-y-0.5" style="background-color: var(--button-secondary-bg); color: var(--text-primary); --tw-ring-offset-color: var(--bg-color); --tw-ring-color: var(--accent-start);">
                  <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2A8.001 8.001 0 0019.419 15m0 0H15" /></svg>
                  Ganti File
              </button>
              <button onclick="clearAllFiles()" class="bg-red-900/50 text-red-400 p-2.5 rounded-lg hover:bg-red-900 hover:text-red-300 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 active:scale-95 hover:scale-105" style="--tw-ring-offset-color: var(--bg-color); --tw-ring-color: #ef4444;" title="Hapus PDF">
                  <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
          </div>

      </div>
  </aside>
</div>

<!-- Toolbar, Tombol, Modal, dll (dari file lama) -->
<div class="pdf-controls">
  <button id="btnZoomOut" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
  <input type="number" id="zoomInput" value="100" min="10" max="400" step="5" />%
  <button id="btnZoomIn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
  <button id="btnUndo" class="gray-btn" title="Undo"><i class="fas fa-undo"></i></button>
  <button id="btnRedo" class="gray-btn" title="Redo"><i class="fas fa-redo"></i></button>
  <button id="btnPanMode" class="gray-btn" title="Pan Mode"><i class="fas fa-hand-paper"></i></button>
  <button id="btnPrevPage" title="Halaman sebelumnya"><i class="fas fa-chevron-up"></i></button>
  <input type="number" id="currentPageInput" value="1" min="1" title="Pilih halaman" />
  <span class="mx-1 text-sm" style="color: var(--text-secondary);">/ <span id="totalPagesSpan">1</span></span>
  <button id="btnNextPage" title="Halaman berikutnya"><i class="fas fa-chevron-down"></i></button>
</div>

<!-- PERUBAHAN: Tombol .add-btn dan .clear-btn dihapus dari sini -->

<div id="custom-context-menu" class="custom-context-menu">
  <ul>
    <li id="context-copy-all">Copy ke Semua Halaman</li>
  </ul>
</div>

<div id="settings-modal-container" class="modal-container hidden fixed inset-0 z-[10000] flex items-center justify-center p-4">
  <div id="settings-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0"></div>
  <div id="settings-modal-content" class="w-full max-w-sm rounded-xl border p-6 shadow-2xl opacity-0 -translate-y-4 relative" style="background-color: var(--card-color); border-color: var(--border-color);">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold">Theme Settings</h2>
      <button id="close-settings-button" class="p-1 rounded-full transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.backgroundColor='var(--border-color)'" onmouseout="this.style.backgroundColor='transparent'"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </div>
    <div class="space-y-4">
      <div class="flex items-center justify-between"><label class="text-sm">Mode</label><div class="flex items-center p-1 rounded-md" style="background-color: var(--button-secondary-bg);"><button id="theme-dark-button" class="px-3 py-1 text-sm rounded-md transition-colors">Dark</button><button id="theme-light-button" class="px-3 py-1 text-sm rounded-md transition-colors">Light</button></div></div>
      <div class="flex items-center justify-between"><label class="text-sm">Accent Color</label><div id="accent-color-picker" class="flex space-x-3"><button class="w-6 h-6 rounded-full transition-all" style="background-image: linear-gradient(to right, var(--accent-purple-start), var(--accent-purple-end));" data-color-name="purple"></button><button class="w-6 h-6 rounded-full transition-all" style="background-image: linear-gradient(to right, var(--accent-blue-start), var(--accent-blue-end));" data-color-name="blue"></button><button class="w-6 h-6 rounded-full transition-all" style="background-image: linear-gradient(to right, var(--accent-emerald-start), var(--accent-emerald-end));" data-color-name="emerald"></button><button class="w-6 h-6 rounded-full transition-all" style="background-image: linear-gradient(to right, var(--accent-rose-start), var(--accent-rose-end));" data-color-name="rose"></button></div></div>
      
      <!-- PENAMBAHAN BARU: Opsi Notifikasi JI -->
      <div class="flex items-center justify-between pt-4 border-t" style="border-color: var(--border-color);">
        <label class="text-sm">Notifikasi Unduh JI</label>
        <div class="flex items-center p-1 rounded-md" style="background-color: var(--button-secondary-bg);">
          <button id="ji-notify-on" class="px-3 py-1 text-sm rounded-md transition-colors">Aktif</button>
          <button id="ji-notify-off" class="px-3 py-1 text-sm rounded-md transition-colors">Nonaktif</button>
        </div>
      </div>
      <!-- AKHIR PENAMBAHAN BARU -->

    </div>
  </div>
</div>

<!-- PENAMBAHAN BARU: Modal Konfirmasi JI -->
<div id="ji-confirm-modal-container" class="modal-container hidden fixed inset-0 z-[10001] flex items-center justify-center p-4">
  <div id="ji-confirm-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0"></div>
  <div id="ji-confirm-modal-content" class="w-full max-w-sm rounded-xl border p-6 shadow-2xl opacity-0 -translate-y-4 relative" style="background-color: var(--card-color); border-color: var(--border-color);">
    <h2 class="text-xl font-bold mb-4">Konfirmasi Unduh</h2>
    <p class="mb-6" style="color: var(--text-secondary);">Apakah Anda yakin bahan JI sudah sesuai dan siap untuk diunduh?</p>
    <div class="flex space-x-4">
      <button id="ji-confirm-cek-ulang" class="action-button action-button-secondary flex-1 py-2">Cek Ulang</button>
      <button id="ji-confirm-sesuai" class="action-button action-button-primary flex-1 py-2 shimmer-button">Sesuai</button>
    </div>
  </div>
</div>
<!-- AKHIR PENAMBAHAN BARU -->


<div id="toast-container"></div>

<script>
(() => {
  // Variabel Global & Referensi DOM
  let pdfData = null, pdfFile = null, currentSignatureDataURL = null;
  let sigNaturalWidth = 0, sigNaturalHeight = 0, copiedStampData = null;
  let activeContainer = null, selectedStamp = null;
  let isAddingShape = false, shapeType = "rectangle", shapeColor = "#ff0000";
  let shapeStartX = 0, shapeStartY = 0, tempShapeEl = null;
  let currentZoom = 1.0, isPanMode = false, startPanX = 0, startPanY = 0;
  let currentTranslateX = 0, currentTranslateY = 0;
  let historyStack = [], redoStack = [];
  let contextMenuData = { target: null };
  let totalPages = 0, currentPage = 1;
  let globalTimestampLeft = null, globalTimestampTop = null; 
  let signatureImageDataURLs = []; // BARU: Ditambahkan dari V1.5
  let showJiNotify = true; // BARU: Variabel status notifikasi

  // DOM Elements
  const pdfFileInput = document.getElementById('pdf-file');
  const sigFileInput = document.getElementById('sig-file');
  const signatureList = document.getElementById('signature-gallery'); // DIMODIFIKASI: ID diubah ke signature-gallery
  const btnDownload = document.getElementById('btnDownload');
  const outputFileNameInput = document.getElementById('outputFileName');
  const pdfPagesWrapper = document.getElementById('pdf-pages-wrapper');
  const userSelect = document.getElementById('user');
  const fontFamilySelect = document.getElementById('font-family');
  const fontSizeSelect = document.getElementById('font-size');
  const fontColorInput = document.getElementById('font-color');
  const btnBold = document.getElementById('btn-bold');
  const btnItalic = document.getElementById('btn-italic');
  const btnUnderline = document.getElementById('btn-underline');
  const btnAlignLeft = document.getElementById('btn-align-left');
  const btnAlignCenter = document.getElementById('btn-align-center');
  const btnAlignRight = document.getElementById('btn-align-right');
  const shapeButtonsContainer = document.getElementById('shape-buttons');
  const shapeButtons = shapeButtonsContainer.querySelectorAll('.shape-btn');
  const shapeColorInput = document.getElementById('shape-color');
  const btnToggleShape = document.getElementById('btnToggleShape');
  const btnZoomIn = document.getElementById('btnZoomIn');
  const btnZoomOut = document.getElementById('btnZoomOut');
  const btnPanMode = document.getElementById('btnPanMode');
  const zoomInput = document.getElementById('zoomInput');
  const btnUndo = document.getElementById('btnUndo');
  const btnRedo = document.getElementById('btnRedo');
  const btnPrevPage = document.getElementById('btnPrevPage');
  const btnNextPage = document.getElementById('btnNextPage');
  const currentPageInput = document.getElementById('currentPageInput');
  const totalPagesSpan = document.getElementById('totalPagesSpan');
  const pdfMain = document.querySelector('.pdf-main');
  const customContextMenu = document.getElementById('custom-context-menu');
  const textFormattingSection = document.getElementById('text-formatting-section');
  
  // PERUBAHAN: Referensi DOM baru
  const dropzone = document.getElementById('dropzone');
  const previewSection = document.getElementById('preview-section');
  const mainContent = document.getElementById('main-content'); // Menggantikan viewerContainer
  const settingsButtonEditor = document.getElementById('settings-button-editor'); // ID baru untuk tombol settings
  
  // BARU: Referensi Modal Konfirmasi JI
  const jiConfirmModalContainer = document.getElementById('ji-confirm-modal-container');
  const jiConfirmOverlay = document.getElementById('ji-confirm-overlay');
  const jiConfirmModalContent = document.getElementById('ji-confirm-modal-content');
  const jiConfirmSesuai = document.getElementById('ji-confirm-sesuai');
  const jiConfirmCekUlang = document.getElementById('ji-confirm-cek-ulang');
  
  // BARU: Referensi Tombol Setting Notifikasi
  const jiNotifyOnBtn = document.getElementById('ji-notify-on');
  const jiNotifyOffBtn = document.getElementById('ji-notify-off');
  
  // --- FUNGSI TEMA & EFEK (dari file lama) ---

  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) {
      console.warn("Toast: ", message);
      return;
    }
    const toast = document.createElement('div');
    let borderColor = 'transparent';
    if (type === 'error') borderColor = 'var(--accent-rose-start)';
    if (type === 'success') borderColor = 'var(--accent-emerald-start)';
    if (type === 'warning') borderColor = '#eab308';
    
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.borderLeft = `4px solid ${borderColor}`;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }

  function setupConstellationEffect() {
    const canvas = document.getElementById('constellation-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let particlesArray;
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      init();
    });
    class Particle {
      constructor(x, y, directionX, directionY, size, color) { this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; this.color = color; }
      draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill(); }
      update() { if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX; if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY; this.x += this.directionX; this.y += this.directionY; this.draw(); }
    }
    function init() {
      particlesArray = [];
      let numberOfParticles = (canvas.height * canvas.width) / 9000;
      for (let i = 0; i < numberOfParticles; i++) {
        let size = (Math.random() * 2) + 1;
        let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
        let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
        let directionX = (Math.random() * .4) - .2;
        let directionY = (Math.random() * .4) - .2;
        let color = getComputedStyle(document.documentElement).getPropertyValue('--accent-start').trim();
        particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
      }
    }
    function connect() {
      let opacityValue = 1;
      for (let a = 0; a < particlesArray.length; a++) {
        for (let b = a; b < particlesArray.length; b++) {
          let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
          if (distance < (canvas.width / 7) * (canvas.height / 7)) {
            opacityValue = 1 - (distance / 20000);
            let color = getComputedStyle(document.documentElement).getPropertyValue('--accent-start').trim();
            if (color.startsWith('#')) {
                const rgb = parseInt(color.slice(1,3),16) + ", " + parseInt(color.slice(3,5),16) + ", " + parseInt(color.slice(5,7),16);
                ctx.strokeStyle = `rgba(${rgb}, ${opacityValue})`;
            } else {
                ctx.strokeStyle = `rgba(168, 85, 247, ${opacityValue})`; // Fallback
            }
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke();
          }
        }
      }
    }
    function animate() { requestAnimationFrame(animate); ctx.clearRect(0, 0, innerWidth, innerHeight); for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update(); connect(); }
    init();
    animate();
    const observer = new MutationObserver((mutations) => { mutations.forEach((mutation) => { if (mutation.type === 'attributes' && mutation.attributeName === 'style') { init(); } }); });
    observer.observe(document.documentElement, { attributes: true });
  }

  function setupThemeEventListeners() {
    const spotlight = document.getElementById('spotlight');
    window.addEventListener('mousemove', (e) => { spotlight.style.left = `${e.clientX}px`; spotlight.style.top = `${e.clientY}px`; });
    
    // PERUBAHAN: Gunakan ID baru dari header
    const settingsButton = document.getElementById('settings-button-editor');
    const closeSettingsButton = document.getElementById('close-settings-button');
    const modalContainer = document.getElementById('settings-modal-container');
    const settingsOverlay = document.getElementById('settings-overlay');
    const settingsModalContent = document.getElementById('settings-modal-content');
    const themeDarkButton = document.getElementById('theme-dark-button');
    const themeLightButton = document.getElementById('theme-light-button');
    const accentColorPicker = document.getElementById('accent-color-picker');

    if (!settingsButton || !modalContainer) return;

    const openModal = () => { modalContainer.classList.remove('hidden'); requestAnimationFrame(() => { settingsOverlay.style.opacity = '1'; settingsModalContent.style.opacity = '1'; settingsModalContent.style.transform = 'translateY(0)'; }); };
    const closeModal = () => { settingsOverlay.style.opacity = '0'; settingsModalContent.style.opacity = '0'; settingsModalContent.style.transform = 'translateY(-1rem)'; setTimeout(() => modalContainer.classList.add('hidden'), 300); };
    
    settingsButton.addEventListener('click', openModal); 
    closeSettingsButton.addEventListener('click', closeModal); 
    settingsOverlay.addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => e.key === 'Escape' && !modalContainer.classList.contains('hidden') && closeModal());
    
    themeDarkButton.addEventListener('click', () => applyTheme('dark')); 
    themeLightButton.addEventListener('click', () => applyTheme('light'));
    accentColorPicker.addEventListener('click', (e) => e.target.tagName === 'BUTTON' && e.target.dataset.colorName && applyAccentColor(e.target.dataset.colorName));
    
    // BARU: Listener untuk setting notifikasi
    jiNotifyOnBtn.addEventListener('click', () => applyJiNotifySetting(true));
    jiNotifyOffBtn.addEventListener('click', () => applyJiNotifySetting(false));
  }
  
  // BARU: Fungsi Modal Konfirmasi JI
  function openJiConfirmModal() {
    if (!jiConfirmModalContainer) return;
    jiConfirmModalContainer.classList.remove('hidden');
    requestAnimationFrame(() => {
      jiConfirmOverlay.style.opacity = '1';
      jiConfirmModalContent.style.opacity = '1';
      jiConfirmModalContent.style.transform = 'translateY(0)';
    });
  }

  function closeJiConfirmModal() {
    if (!jiConfirmModalContainer) return;
    jiConfirmOverlay.style.opacity = '0';
    jiConfirmModalContent.style.opacity = '0';
    jiConfirmModalContent.style.transform = 'translateY(-1rem)';
    setTimeout(() => jiConfirmModalContainer.classList.add('hidden'), 300);
  }

  // BARU: Listener untuk tombol modal JI
  jiConfirmCekUlang.addEventListener('click', closeJiConfirmModal);
  jiConfirmOverlay.addEventListener('click', closeJiConfirmModal);
  // Listener jiConfirmSesuai ada di bagian Download PDF

  function applyTheme(theme) { 
    document.body.classList.toggle('light-theme', theme === 'light'); 
    document.getElementById('theme-light-button').style.backgroundColor = theme === 'light' ? 'var(--border-color)' : 'transparent'; 
    document.getElementById('theme-dark-button').style.backgroundColor = theme === 'dark' ? 'var(--border-color)' : 'transparent'; 
    localStorage.setItem('pdf-editor-theme', theme); 
  }

  function applyAccentColor(colorName) {
    const root = document.documentElement;
    // PERUBAHAN: Update ikon di header dan dropzone
    const appIcon = document.getElementById('app-icon');
    const dropzoneIcon = document.getElementById('dropzone-icon');
    const iconMap = { purple: 'https://ajmaerlangga.github.io/image/icon_merge_purple.png', blue: 'https://ajmaerlangga.github.io/image/icon_merge_blue.png', emerald: 'https://ajmaerlangga.github.io/image/icon_merge_green.png', rose: 'https://ajmaerlangga.github.io/image/icon_merge_red.png' };
    const iconUrl = iconMap[colorName] || iconMap.purple;
    if (appIcon) appIcon.src = iconUrl;
    if (dropzoneIcon) dropzoneIcon.src = iconUrl;

    root.style.setProperty('--accent-start', `var(--accent-${colorName}-start)`);
    root.style.setProperty('--accent-end', `var(--accent-${colorName}-end)`);
    document.querySelectorAll('#accent-color-picker button').forEach(btn => { const ringColor = document.body.classList.contains('light-theme') ? '#ffffff' : '#111827'; btn.style.boxShadow = btn.dataset.colorName === colorName ? `0 0 0 2px ${ringColor}, 0 0 0 4px var(--accent-start)` : 'none'; });
    localStorage.setItem('pdf-editor-accent-name', colorName);
  }

  // BARU: Fungsi untuk setting Notifikasi JI
  function applyJiNotifySetting(show) {
    showJiNotify = show;
    if (jiNotifyOnBtn && jiNotifyOffBtn) {
      jiNotifyOnBtn.style.backgroundColor = show ? 'var(--border-color)' : 'transparent';
      jiNotifyOffBtn.style.backgroundColor = !show ? 'var(--border-color)' : 'transparent';
    }
    localStorage.setItem('pdf-editor-ji-notify', show);
  }

  function loadSavedTheme() { 
    applyTheme(localStorage.getItem('pdf-editor-theme') || 'dark'); 
    applyAccentColor(localStorage.getItem('pdf-editor-accent-name') || 'purple'); 
    shapeColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--accent-rose-start').trim();
    shapeColor = shapeColorInput.value;
    
    // BARU: Muat setting notifikasi
    const savedJiNotify = localStorage.getItem('pdf-editor-ji-notify');
    applyJiNotifySetting(savedJiNotify === null ? true : (savedJiNotify === 'true'));
  }
  
  // --- FUNGSI INTI EDITOR (dari file lama) ---

  function hexToRgbNormalized(hex) {
    hex = hex.replace('#', '');
    const bigint = parseInt(hex, 16);
    const r = ((bigint >> 16) & 255) / 255;
    const g = ((bigint >> 8) & 255) / 255;
    const b = (bigint & 255) / 255;
    return PDFLib.rgb(r, g, b);
  }

  // Event Listener Format Teks
  btnBold.addEventListener('click', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      const currentWeight = window.getComputedStyle(selectedStamp).fontWeight;
      if (parseInt(currentWeight) >= 700) {
        selectedStamp.style.fontWeight = 'normal';
        btnBold.classList.remove('active-btn');
      } else {
        selectedStamp.style.fontWeight = 'bold';
        btnBold.classList.add('active-btn');
      }
      saveHistory();
    }
  });
  btnItalic.addEventListener('click', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      const currentStyle = window.getComputedStyle(selectedStamp).fontStyle;
      if (currentStyle === 'italic') {
        selectedStamp.style.fontStyle = 'normal';
        btnItalic.classList.remove('active-btn');
      } else {
        selectedStamp.style.fontStyle = 'italic';
        btnItalic.classList.add('active-btn');
      }
      saveHistory();
    }
  });
  btnUnderline.addEventListener('click', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      const currentDecoration = window.getComputedStyle(selectedStamp).textDecorationLine;
      if (currentDecoration.includes('underline')) {
        selectedStamp.style.textDecoration = 'none';
        btnUnderline.classList.remove('active-btn');
      } else {
        selectedStamp.style.textDecoration = 'underline';
        btnUnderline.classList.add('active-btn');
      }
      saveHistory();
    }
  });
  btnAlignLeft.addEventListener('click', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      selectedStamp.style.textAlign = 'left';
      btnAlignLeft.classList.add('active-btn');
      btnAlignCenter.classList.remove('active-btn');
      btnAlignRight.classList.remove('active-btn');
      saveHistory();
    }
  });
  btnAlignCenter.addEventListener('click', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      selectedStamp.style.textAlign = 'center';
      btnAlignCenter.classList.add('active-btn');
      btnAlignLeft.classList.remove('active-btn');
      btnAlignRight.classList.remove('active-btn');
      saveHistory();
    }
  });
  btnAlignRight.addEventListener('click', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      selectedStamp.style.textAlign = 'right';
      btnAlignRight.classList.add('active-btn');
      btnAlignLeft.classList.remove('active-btn');
      btnAlignCenter.classList.remove('active-btn');
      saveHistory();
    }
  });

  // Fungsi Zoom & Pan
  function updateTransform() {
    pdfPagesWrapper.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`;
  }
  btnZoomIn.addEventListener('click', () => {
    currentZoom += 0.1;
    zoomInput.value = Math.round(currentZoom * 100);
    updateTransform();
  });
  btnZoomOut.addEventListener('click', () => {
    currentZoom = Math.max(0.1, currentZoom - 0.1);
    zoomInput.value = Math.round(currentZoom * 100);
    updateTransform();
  });
  zoomInput.addEventListener('change', () => {
    currentZoom = zoomInput.value / 100;
    updateTransform();
  });
  btnPanMode.addEventListener('click', () => {
    isPanMode = !isPanMode;
    btnPanMode.classList.toggle('active-btn', isPanMode);
    pdfMain.style.cursor = isPanMode ? 'grab' : 'default';
  });
  pdfMain.addEventListener('mousedown', (e) => {
    if (!isPanMode) return;
    if (e.target.closest('.stamp-container, .shape-element, .text-element, .resize-handle, .timestamp-preview')) {
        return;
    }
    pdfMain.style.cursor = 'grabbing';
    startPanX = e.clientX;
    startPanY = e.clientY;
    const onMouseMove = (eMove) => {
      const dx = eMove.clientX - startPanX;
      const dy = eMove.clientY - startPanY;
      currentTranslateX += dx;
      currentTranslateY += dy;
      startPanX = eMove.clientX;
      startPanY = eMove.clientY;
      updateTransform();
    };
    const onMouseUp = () => {
      pdfMain.style.cursor = 'grab';
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });

  // Fungsi History (Undo/Redo)
  function saveHistory() {
    const state = [];
    document.querySelectorAll('.preview-container').forEach(container => {
      const interactiveElements = Array.from(container.children)
        .filter(child => child.tagName.toLowerCase() !== 'canvas' && !child.classList.contains('timestamp-preview'))
        .map(child => child.outerHTML)
        .join('');
      state.push({ id: container.id, interactive: interactiveElements });
    });
    historyStack.push(state);
    redoStack = [];
    updateUndoRedoButtons();
  }
  function restoreHistory(state) {
    state.forEach(item => {
      const container = document.getElementById(item.id);
      if (container) {
        const canvas = container.querySelector('canvas');
        const timestamp = container.querySelector('.timestamp-preview');
        container.innerHTML = "";
        if (canvas) container.appendChild(canvas);
        if (timestamp) container.appendChild(timestamp);
        container.insertAdjacentHTML('beforeend', item.interactive);
      }
    });
    rebindInteractiveEvents();
  }
  function rebindInteractiveEvents() {
    document.querySelectorAll('.preview-container').forEach(container => {
      const timestampEl = container.querySelector('.timestamp-preview');
      if(timestampEl) {
        timestampEl.addEventListener('mousedown', (e) => {
          if (isPanMode) { e.stopPropagation(); return; }
          startDrag(e, timestampEl, container, true); 
        });
      }
      container.querySelectorAll('.stamp-container, .text-element, .shape-element').forEach(element => {
        element.addEventListener('mousedown', (ev) => {
          if (ev.target.classList.contains('resize-handle') || ev.target.classList.contains('stamp-delete-button')) return;
          if (isPanMode) { ev.stopPropagation(); return; }
          selectStamp(element);
          startDrag(ev, element, container, false);
        });
        element.addEventListener('click', (ev) => {
          if (ev.target.classList.contains('stamp-delete-button')) return;
          selectStamp(element)
        });
        const deleteBtn = element.querySelector('.stamp-delete-button');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            element.remove();
            saveHistory();
          });
        }
        if (element.classList.contains('text-element')) {
          element.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            element.setAttribute("contenteditable", "true");
            element.focus();
          });
          element.addEventListener('blur', () => { 
            element.removeAttribute("contenteditable"); 
            saveHistory();
          });
        }
      });
    });
  }
  function updateUndoRedoButtons() {
    btnUndo.disabled = historyStack.length <= 1;
    btnRedo.disabled = redoStack.length === 0;
    btnUndo.style.opacity = btnUndo.disabled ? 0.5 : 1;
    btnRedo.style.opacity = btnRedo.disabled ? 0.5 : 1;
  }
  btnUndo.addEventListener('click', () => {
    if (historyStack.length > 1) {
      const currentState = historyStack.pop();
      redoStack.push(currentState);
      const previousState = historyStack[historyStack.length - 1];
      restoreHistory(previousState);
      updateUndoRedoButtons();
    }
  });
  btnRedo.addEventListener('click', () => {
    if (redoStack.length > 0) {
      const state = redoStack.pop();
      historyStack.push(state);
      restoreHistory(state);
      updateUndoRedoButtons();
    }
  });

  // Fungsi Clear & Trigger File Input
  window.triggerFileInput = () => pdfFileInput.click();
  window.clearAllFiles = () => {
    pdfFileInput.value = "";
    pdfData = null;
    pdfFile = null;
    pdfPagesWrapper.innerHTML = "";
    signatureList.innerHTML = ""; 
    signatureImageDataURLs = []; // BARU: Reset galeri
    currentSignatureDataURL = null; 
    activeContainer = null;
    currentZoom = 1.0;
    currentTranslateX = 0;
    currentTranslateY = 0;
    zoomInput.value = 100;
    pdfPagesWrapper.style.transform = `translate(0px, 0px) scale(1)`;
    historyStack = [];
    redoStack = [];
    totalPages = 0;
    currentPage = 1;
    currentPageInput.value = 1;
    totalPagesSpan.textContent = 1;
    globalTimestampLeft = null; 
    globalTimestampTop = null;
    updateUndoRedoButtons();
    
    // PERUBAHAN: Tampilkan dropzone
    dropzone.classList.remove('hidden');
    previewSection.classList.add('hidden');
    // PERBAIKAN: Sembunyikan toolbar
    document.querySelector('.pdf-controls').style.display = 'none';
    
    // PERUBAHAN: Reset tombol timestamp
    document.querySelectorAll('.timestamp-btn').forEach(btn => btn.classList.remove('active-timestamp'));
    userSelect.value = '0';
  };

  // Render PDF
  pdfFileInput.addEventListener('change', async () => {
    const file = pdfFileInput.files[0];
    if (!file) { showToast("Pilih file PDF terlebih dahulu.", "warning"); return; }
    pdfFile = file;
    pdfData = await file.arrayBuffer();
    await renderPDF(pdfData);
  });
  
  async function renderPDF(arrayBuffer) {
    pdfPagesWrapper.innerHTML = "";
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    totalPages = pdf.numPages;
    totalPagesSpan.textContent = totalPages;
    currentPage = 1;
    currentPageInput.value = currentPage;
    
    for (let i = 1; i <= totalPages; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 1 });
      const desiredWidth = 700;
      const scale = desiredWidth / viewport.width;
      const scaledViewport = page.getViewport({ scale });
      const pageContainer = document.createElement('div');
      pageContainer.className = 'preview-container';
      pageContainer.id = `page-container-${i}`;
      pageContainer.style.width = scaledViewport.width + 'px';
      pageContainer.style.height = scaledViewport.height + 'px';
      pageContainer.setAttribute('data-page', i);
      pageContainer.setAttribute('data-scale', scale);
      pageContainer.setAttribute('data-original-height', viewport.height);
      const ratio = window.devicePixelRatio || 1;
      const canvas = document.createElement('canvas');
      canvas.width = scaledViewport.width * ratio;
      canvas.height = scaledViewport.height * ratio;
      canvas.style.width = scaledViewport.width + 'px';
      canvas.style.height = scaledViewport.height + 'px';
      const context = canvas.getContext('2d');
      context.scale(ratio, ratio);
      await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
      pageContainer.appendChild(canvas);
      pdfPagesWrapper.appendChild(pageContainer);
      
      pageContainer.addEventListener('click', () => { 
        activeContainer = pageContainer; 
        document.querySelectorAll('.preview-container').forEach(c => c.style.borderColor = 'var(--border-color)');
        pageContainer.style.borderColor = 'var(--accent-start)';
      });
      pageContainer.addEventListener('dragover', (e) => e.preventDefault());
      pageContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!currentSignatureDataURL) {
          showToast("Pilih file gambar TTD terlebih dahulu.", "warning");
          return;
        }
        const rect = pageContainer.getBoundingClientRect();
        
        // --- PERBAIKAN KOORDINAT (1) ---
        // Menghapus `(currentTranslateX / currentZoom)` dan `(currentTranslateY / currentZoom)`
        // karena `getBoundingClientRect()` sudah memperhitungkannya.
        const dropX = (e.clientX - rect.left) / currentZoom;
        const dropY = (e.clientY - rect.top) / currentZoom;
        
        const stampContainer = createStampElement(dropX, dropY, pageContainer, scale);
        pageContainer.appendChild(stampContainer);
        selectStamp(stampContainer);
        saveHistory();
      });
      pageContainer.addEventListener('dblclick', (e) => {
        if (isAddingShape) return;
        if (e.target === pageContainer || e.target.tagName.toLowerCase() === "canvas") {
          const rect = pageContainer.getBoundingClientRect();
          
          // --- PERBAIKAN KOORDINAT (2) ---
          // Menghapus `(currentTranslateX / currentZoom)` dan `(currentTranslateY / currentZoom)`
          const textX = (e.clientX - rect.left) / currentZoom;
          const textY = (e.clientY - rect.top) / currentZoom;
          
          createTextInputAt(pageContainer, textX, textY);
        }
      });
    }

    // PERUBAHAN: Sembunyikan dropzone, tampilkan preview
    dropzone.classList.add('hidden');
    previewSection.classList.remove('hidden');
    // PERBAIKAN: Tampilkan toolbar
    document.querySelector('.pdf-controls').style.display = 'flex';

    currentZoom = 1.0;
    currentTranslateX = 0;
    currentTranslateY = 0;
    pdfPagesWrapper.style.transform = `translate(0px, 0px) scale(1)`;
    zoomInput.value = 100;
    updateTimestampPreview();
    historyStack = []; 
    redoStack = [];
    saveHistory();
    updateUndoRedoButtons();
  }
  
  pdfMain.addEventListener('scroll', onScrollUpdatePage);
  function onScrollUpdatePage() {
    const mainRect = pdfMain.getBoundingClientRect();
    const mainCenterY = mainRect.top + (mainRect.height / 2);
    let bestPage = currentPage;
    let minDistance = Infinity;
    document.querySelectorAll('.preview-container').forEach(container => {
      const containerRect = container.getBoundingClientRect();
      const containerCenterY = containerRect.top + (containerRect.height / 2);
      const distance = Math.abs(containerCenterY - mainCenterY);
      if (distance < minDistance) {
        minDistance = distance;
        bestPage = parseInt(container.dataset.page);
      }
    });
    if (bestPage !== currentPage) {
      currentPage = bestPage;
      currentPageInput.value = currentPage;
    }
  }
  function formatTimestamp() {
    const now = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    return `${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()} - ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  }
  function updateTimestampPreview() {
    const selectedUser = userSelect.value;
    
    document.querySelectorAll('.preview-container').forEach(container => {
      const existingTimestamp = container.querySelector('.timestamp-preview');
      if (existingTimestamp) existingTimestamp.remove();

      if (selectedUser !== "0") {
        const timestamp = formatTimestamp();
        const texttimeAdd = `${selectedUser} - ${timestamp}`;
        const timestampEl = document.createElement('div');
        timestampEl.className = "timestamp-preview";
        
        if(globalTimestampLeft && globalTimestampTop) { 
          timestampEl.style.left = globalTimestampLeft;
          timestampEl.style.top = globalTimestampTop;
        } else {
          const containerHeight = container.clientHeight;
          const leftPos = (selectedUser === 'sales') ? 200 : 50; 
          timestampEl.style.left = leftPos + "px";
          timestampEl.style.top = containerHeight - 10 + "px";
        }
        
        timestampEl.textContent = texttimeAdd;
        container.appendChild(timestampEl);

        timestampEl.addEventListener('mousedown', (e) => {
          if (isPanMode) { e.stopPropagation(); return; }
          startDrag(e, timestampEl, container, true);
        });
      }
    });
  }
  userSelect.addEventListener('change', updateTimestampPreview);

  // BARU: Listener untuk tombol timestamp V1.5
  document.getElementById('timestamp-controls').addEventListener('click', (e) => {
      const target = e.target.closest('.timestamp-btn');
      if (!target) return;
      const type = target.dataset.type;
      if (!type) return;

      // Hapus kelas aktif dari semua tombol
      document.querySelectorAll('.timestamp-btn').forEach(btn => btn.classList.remove('active-timestamp'));
      
      // Atur nilai select asli (yang tersembunyi)
      if (type.toUpperCase() === 'SSS') {
          userSelect.value = 'sss';
          target.classList.add('active-timestamp');
      } else if (type.toUpperCase() === 'SALES') {
          userSelect.value = 'sales';
          target.classList.add('active-timestamp');
      } else { // NONE
          userSelect.value = '0';
          target.classList.add('active-timestamp'); // BARU: Tetap aktifkan "Nonaktif"
      }
      
      // Picu event 'change' pada select asli secara manual
      // Ini akan menjalankan fungsi updateTimestampPreview() yang sudah ada
      userSelect.dispatchEvent(new Event('change'));
  });

  // BARU: Fungsi untuk memicu upload TTD dari tombol V1.5
  window.triggerSignatureUpload = () => {
    sigFileInput.click();
  }

  // DIMODIFIKASI: Event listener sigFileInput diubah untuk menangani galeri
  sigFileInput.addEventListener('change', (event) => {
    const files = event.target.files;
    if (!files || files.length === 0) return;

    const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
    if (imageFiles.length === 0) return; 

    let filesProcessed = 0;
    for (const file of imageFiles) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataURL = e.target.result;
            if (!signatureImageDataURLs.includes(dataURL)) {
                signatureImageDataURLs.push(dataURL);
            }
            filesProcessed++;
            if (filesProcessed === imageFiles.length) {
                renderSignatureGallery();
            }
        };
        reader.readAsDataURL(file);
    }
    sigFileInput.value = ""; // Reset input file
  });

  // BARU: Fungsi renderSignatureGallery dari V1.5 (dimasukkan ke IIFE)
  function renderSignatureGallery() {
      signatureList.innerHTML = ''; // signatureList sekarang merujuk ke #signature-gallery

      signatureImageDataURLs.forEach((dataURL, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'sig-thumbnail-wrapper';

          const img = document.createElement('img');
          img.src = dataURL;
          img.className = 'sig-thumbnail';
          // Hapus draggable dari V1.5, kita pakai klik
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'sig-thumbnail-delete';
          deleteBtn.innerHTML = '&times;';
          deleteBtn.title = 'Hapus TTD ini';
          deleteBtn.onclick = (e) => {
              e.stopPropagation();
              const removedDataURL = signatureImageDataURLs.splice(index, 1)[0]; 
              renderSignatureGallery();
              if (currentSignatureDataURL === removedDataURL) {
                currentSignatureDataURL = null; // Hapus jika TTD yg aktif dihapus
              }
          };

          // DIMODIFIKASI: Listener klik pada wrapper (dari logic tes.html asli)
          wrapper.addEventListener('click', () => {
              currentSignatureDataURL = dataURL;
              
              // Update kelas aktif
              document.querySelectorAll('.sig-thumbnail-wrapper').forEach(thumb => { 
                thumb.classList.remove('signature-thumb-active'); 
              });
              wrapper.classList.add('signature-thumb-active');
              
              // Logic asli untuk mendapatkan ukuran gambar
              const tempImg = new Image();
              tempImg.onload = () => {
                sigNaturalWidth = tempImg.naturalWidth;
                sigNaturalHeight = tempImg.naturalHeight;
              };
              tempImg.src = dataURL;

              // Kita HAPUS bagian yang otomatis menambahkan TTD ke halaman
              // Ini agar perilakunya seperti V1.5: pilih dulu, baru drop/tambah
          });
          
          // BARU: Set kelas aktif jika ini adalah TTD yang sedang dipilih
          if (dataURL === currentSignatureDataURL) {
            wrapper.classList.add('signature-thumb-active');
          }

          wrapper.appendChild(img);
          wrapper.appendChild(deleteBtn);
          signatureList.appendChild(wrapper);
      });
  }

  function createStampElement(dropX, dropY, container, scale) {
    const stampWidth = sigNaturalWidth > 150 ? 150 : sigNaturalWidth;
    const stampHeight = (stampWidth / sigNaturalWidth) * sigNaturalHeight;
    
    const stampContainer = document.createElement('div');
    stampContainer.className = "stamp-container";
    stampContainer.style.width = stampWidth + "px";
    stampContainer.style.height = stampHeight + "px";
    stampContainer.style.left = (dropX - stampWidth / 2) + "px";
    stampContainer.style.top = (dropY - stampHeight / 2) + "px";
    
    const img = document.createElement('img');
    img.src = currentSignatureDataURL;
    stampContainer.appendChild(img);
    
    const resizeHandle = document.createElement('div');
    resizeHandle.className = "resize-handle";
    stampContainer.appendChild(resizeHandle);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = "stamp-delete-button";
    deleteBtn.textContent = "";
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      stampContainer.remove();
      saveHistory();
    });
    stampContainer.appendChild(deleteBtn);
    
    stampContainer.addEventListener('mousedown', (e) => {
      if (e.target.classList.contains('resize-handle') || e.target.classList.contains('stamp-delete-button')) return;
      if (isPanMode) { e.stopPropagation(); return; }
      selectStamp(stampContainer);
      startDrag(e, stampContainer, container, false);
    });
    stampContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('stamp-delete-button')) return;
      selectStamp(stampContainer)
    });
    return stampContainer;
  }

  function selectStamp(element) {
    if (selectedStamp && selectedStamp !== element) {
      selectedStamp.classList.remove('stamp-selected');
    }
    selectedStamp = element;
    element.classList.add('stamp-selected');
    
    if (element.classList.contains('text-element')) {
      textFormattingSection.style.display = 'block';
      fontFamilySelect.value = element.style.fontFamily || "Helvetica";
      fontSizeSelect.value = parseInt(element.style.fontSize) || 16;
      const colorCSS = window.getComputedStyle(element).color;
      fontColorInput.value = rgbToHex(colorCSS);
      btnBold.classList.toggle('active-btn', element.style.fontWeight === "bold");
      btnItalic.classList.toggle('active-btn', element.style.fontStyle === "italic");
      btnUnderline.classList.toggle('active-btn', element.style.textDecoration.includes("underline"));
      if (element.style.textAlign === 'center') {
        btnAlignCenter.classList.add('active-btn');
        btnAlignLeft.classList.remove('active-btn');
        btnAlignRight.classList.remove('active-btn');
      } else if (element.style.textAlign === 'right') {
        btnAlignRight.classList.add('active-btn');
        btnAlignLeft.classList.remove('active-btn');
        btnAlignCenter.classList.remove('active-btn');
      } else {
        btnAlignLeft.classList.add('active-btn');
        btnAlignCenter.classList.remove('active-btn');
        btnAlignRight.classList.remove('active-btn');
      }
    } else if (element.classList.contains('shape-element')) {
      textFormattingSection.style.display = 'none';
      shapeColorInput.value = element.getAttribute('data-color');
      shapeButtons.forEach(btn => {
        btn.classList.toggle('active-btn', btn.dataset.shape === element.dataset.shape);
      });
    } else {
      textFormattingSection.style.display = 'none';
    }
  }

  function rgbToHex(rgbStr) {
    const match = rgbStr.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if (!match) return "#000000";
    const r = parseInt(match[1]).toString(16).padStart(2, "0");
    const g = parseInt(match[2]).toString(16).padStart(2, "0");
    const b = parseInt(match[3]).toString(16).padStart(2, "0");
    return `#${r}${g}${b}`;
  }

  function createTextInputAt(container, x, y) {
    const textElement = document.createElement('div');
    textElement.className = "text-element";
    textElement.style.left = x + "px";
    textElement.style.top = y + "px";
    textElement.innerText = "Ketik di sini...";
    textElement.style.fontFamily = fontFamilySelect.value;
    textElement.style.fontSize = fontSizeSelect.value + "px";
    textElement.style.color = fontColorInput.value;
    textElement.style.zIndex = 9999;
    textElement.style.width = "150px";
    textElement.style.border = "1px dashed #000";
    
    const resizeHandle = document.createElement('div');
    resizeHandle.className = "resize-handle";
    textElement.appendChild(resizeHandle);
    
    textElement.addEventListener('mousedown', (e) => {
      if (e.target.classList.contains('resize-handle')) return;
      if (isPanMode) { e.stopPropagation(); return; }
      selectStamp(textElement);
      startDrag(e, textElement, container, false);
    });
    textElement.addEventListener('click', () => selectStamp(textElement));
    textElement.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      textElement.setAttribute("contenteditable", "true");
      textElement.focus();
    });
    textElement.addEventListener('blur', () => { 
      textElement.removeAttribute("contenteditable"); 
      textElement.style.border = "none";
      if(textElement.innerText.trim() === "" || textElement.innerText.trim() === "Ketik di sini...") {
        textElement.remove();
      }
      saveHistory(); 
    });
    
    container.appendChild(textElement);
    selectStamp(textElement);
    
    textElement.setAttribute("contenteditable", "true");
    textElement.focus();
    if (window.getSelection) {
        const selection = window.getSelection();
        selection.selectAllChildren(textElement);
    } else {
        document.execCommand('selectAll', false, null);
    }
  }

  fontFamilySelect.addEventListener('input', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      selectedStamp.style.fontFamily = fontFamilySelect.value;
    }
  });
  fontSizeSelect.addEventListener('input', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      selectedStamp.style.fontSize = fontSizeSelect.value + "px";
    }
  });
  fontColorInput.addEventListener('input', () => {
    if (selectedStamp && selectedStamp.classList.contains('text-element')) {
      selectedStamp.style.color = fontColorInput.value;
    }
  });

  function startDrag(e, element, container, isTimestamp = false) {
    e.preventDefault();
    let isDragging = true;
    const elementRect = element.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    
    const offsetX = (e.clientX - elementRect.left) / currentZoom;
    const offsetY = (e.clientY - elementRect.top) / currentZoom;
    
    const onMouseMove = (eMove) => {
      if (!isDragging) return;
      
      // --- PERBAIKAN KOORDINAT (3) ---
      // Menghapus `(currentTranslateX / currentZoom)` dan `(currentTranslateY / currentZoom)`
      let newX = (eMove.clientX - containerRect.left) / currentZoom - offsetX;
      let newY = (eMove.clientY - containerRect.top) / currentZoom - offsetY;
      
      newX = Math.max(0, Math.min(newX, container.clientWidth - element.offsetWidth));
      newY = Math.max(0, Math.min(newY, container.clientHeight - element.offsetHeight));
      
      element.style.left = newX + "px";
      element.style.top = newY + "px";

      if (isTimestamp) {
        const newLeft = newX + "px";
        const newTop = newY + "px";
        document.querySelectorAll('.timestamp-preview').forEach(ts => {
            if (ts !== element) {
                ts.style.left = newLeft;
                ts.style.top = newTop;
            }
        });
      }
    };
    const onMouseUp = () => {
      isDragging = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      if (!isTimestamp) { 
        saveHistory();
      } else {
        globalTimestampLeft = element.style.left;
        globalTimestampTop = element.style.top;
      }
    };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }

  function startResize(e, element) {
    e.preventDefault();
    let isResizing = true;
    const startX = e.clientX;
    const startY = e.clientY;
    
    if (element.classList.contains('text-element')) {
      const startWidth = element.offsetWidth;
      const onMouseMove = (eMove) => {
        if (!isResizing) return;
        const deltaX = eMove.clientX - startX;
        let newWidth = startWidth + (deltaX / currentZoom);
        newWidth = Math.max(newWidth, 50);
        element.style.width = newWidth + "px";
      };
      const onMouseUp = () => {
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveHistory();
      };
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);

    } else {
      let startWidth = element.offsetWidth;
      let startHeight = element.offsetHeight;
      const aspectRatio = startWidth / startHeight;
      
      const onMouseMove = (eMove) => {
        if (!isResizing) return;
        const deltaX = eMove.clientX - startX;
        let newWidth = startWidth + (deltaX / currentZoom);
        newWidth = Math.max(newWidth, 20);
        let newHeight = newWidth / aspectRatio;
        
        element.style.width = newWidth + "px";
        element.style.height = newHeight + "px";
      };
      const onMouseUp = () => {
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveHistory();
      };
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
  }
  document.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('resize-handle')) {
      startResize(e, e.target.parentElement);
    }
    if (!e.target.closest('.stamp-container, .shape-element, .text-element, aside, .pdf-controls, .timestamp-preview')) {
      if (selectedStamp) {
        selectedStamp.classList.remove('stamp-selected');
        selectedStamp = null;
        textFormattingSection.style.display = 'none';
      }
    }
  });
  document.addEventListener('keydown', (e) => {
    if (!selectedStamp) return;
    if (e.key === "Delete" || e.key === "Backspace") {
      if(document.activeElement === selectedStamp && selectedStamp.isContentEditable) return;
      
      selectedStamp.remove();
      selectedStamp = null;
      textFormattingSection.style.display = 'none';
      saveHistory();
    }
  });
  
  // Fungsi Copy Paste
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'c') {
      e.preventDefault();
      if (selectedStamp) {
        copyElement(selectedStamp);
        showToast("Elemen disalin!", "success");
      }
    }
    if (e.ctrlKey && e.key === 'v') {
      e.preventDefault();
      if (copiedStampData && activeContainer) {
        const centerX = activeContainer.clientWidth / 2;
        const centerY = activeContainer.clientHeight / 2;
        pasteCopiedElement(activeContainer, centerX, centerY, false);
        saveHistory();
      }
    }
  });
  
  document.addEventListener('contextmenu', (e) => {
    const targetElement = e.target.closest('.stamp-container, .text-element, .shape-element');
    
    if (targetElement) {
      e.preventDefault();
      contextMenuData.target = targetElement;
      showContextMenu(e.pageX, e.pageY);
    } else {
      hideContextMenu();
    }
  });

  function showContextMenu(pageX, pageY) {
    customContextMenu.style.left = pageX + "px";
    customContextMenu.style.top = pageY + "px";
    customContextMenu.style.display = "block";
  }
  function hideContextMenu() {
    customContextMenu.style.display = "none";
  }

  document.getElementById('context-copy-all').addEventListener('click', () => {
    if (contextMenuData.target) {
      copyElement(contextMenuData.target);
      if (copiedStampData) {
        document.querySelectorAll('.preview-container').forEach(container => {
          if (container.id !== contextMenuData.target.closest('.preview-container').id) {
             pasteCopiedElement(container, 0, 0, true);
          }
        });
        saveHistory();
        showToast("Disalin ke semua halaman!", "success");
      }
    }
    hideContextMenu();
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.custom-context-menu')) {
      hideContextMenu();
    }
  });

  function copyElement(element) {
    if (!element) return;
    selectedStamp = element;
    if (selectedStamp.classList.contains('text-element')) {
      const computedStyle = window.getComputedStyle(selectedStamp);
      copiedStampData = {
        type: 'text',
        width: selectedStamp.offsetWidth,
        height: selectedStamp.offsetHeight,
        text: selectedStamp.innerText,
        fontFamily: computedStyle.fontFamily,
        fontSize: computedStyle.fontSize,
        fontColor: computedStyle.color,
        fontWeight: computedStyle.fontWeight,
        fontStyle: computedStyle.fontStyle,
        textDecoration: computedStyle.textDecoration,
        textAlign: computedStyle.textAlign,
        left: selectedStamp.style.left,
        top: selectedStamp.style.top
      };
    } else if (selectedStamp.querySelector('img')) {
      copiedStampData = {
        type: 'stamp',
        width: selectedStamp.offsetWidth,
        height: selectedStamp.offsetHeight,
        src: selectedStamp.querySelector('img').src,
        left: selectedStamp.style.left,
        top: selectedStamp.style.top
      };
    } else if (selectedStamp.getAttribute('data-shape')) {
      copiedStampData = {
        type: 'shape',
        width: selectedStamp.offsetWidth,
        height: selectedStamp.offsetHeight,
        shape: selectedStamp.getAttribute('data-shape'),
        color: selectedStamp.getAttribute('data-color'),
        left: selectedStamp.style.left,
        top: selectedStamp.style.top,
        angle: selectedStamp.dataset.angle || 0,
        thickness: selectedStamp.dataset.thickness || 2
      };
    }
  }
  
  function pasteCopiedElement(container, posX, posY, useCopiedCoordinates) {
    let newElement;
    if (!copiedStampData) return;
    let left, top;
    
    if (useCopiedCoordinates && copiedStampData.left && copiedStampData.top) {
      left = copiedStampData.left;
      top = copiedStampData.top;
      const existing = container.querySelector(`[style*="left: ${left}"][style*="top: ${top}"]`);
      if (existing) return; 

    } else {
      left = (posX - copiedStampData.width / 2) + "px";
      top = (posY - copiedStampData.height / 2) + "px";
    }
    
    if (copiedStampData.type === 'stamp') {
      newElement = document.createElement('div');
      newElement.className = "stamp-container";
      newElement.style.width = copiedStampData.width + "px";
      newElement.style.height = copiedStampData.height + "px";
      const img = document.createElement('img');
      img.src = copiedStampData.src;
      newElement.appendChild(img);
    } else if (copiedStampData.type === 'shape') {
      newElement = document.createElement('div');
      newElement.className = "shape-element";
      newElement.setAttribute('data-shape', copiedStampData.shape);
      newElement.setAttribute('data-color', copiedStampData.color);
      newElement.style.width = copiedStampData.width + "px";
      newElement.style.height = copiedStampData.height + "px";
      if (copiedStampData.shape === 'line') {
        newElement.style.background = "transparent";
        newElement.style.borderTop = `${copiedStampData.thickness}px solid ${copiedStampData.color}`;
        newElement.style.transform = `rotate(${copiedStampData.angle}deg)`;
        newElement.dataset.angle = copiedStampData.angle;
        newElement.dataset.thickness = copiedStampData.thickness;
      } else {
        newElement.style.background = copiedStampData.color;
        if (copiedStampData.shape === 'ellipse') {
          newElement.style.borderRadius = "50%";
        }
      }
    } else if (copiedStampData.type === 'text') {
      newElement = document.createElement('div');
      newElement.className = "text-element";
      newElement.innerText = copiedStampData.text;
      newElement.style.fontFamily = copiedStampData.fontFamily || "Helvetica";
      newElement.style.fontSize = copiedStampData.fontSize || "12px";
      newElement.style.color = copiedStampData.fontColor || "#000000";
      newElement.style.fontWeight = copiedStampData.fontWeight || "normal";
      newElement.style.fontStyle = copiedStampData.fontStyle || "normal";
      newElement.style.textDecoration = copiedStampData.textDecoration || "none";
      newElement.style.textAlign = copiedStampData.textAlign || "left";
      newElement.style.width = copiedStampData.width + "px";
    }
    
    if (newElement) {
      newElement.style.left = left;
      newElement.style.top = top;
      
      const resizeHandle = document.createElement('div');
      resizeHandle.className = "resize-handle";
      newElement.appendChild(resizeHandle);
      
      if (copiedStampData.type !== 'text') {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = "stamp-delete-button";
        deleteBtn.textContent = "";
        deleteBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          newElement.remove();
          saveHistory();
        });
        newElement.appendChild(deleteBtn);
      }

      newElement.addEventListener('mousedown', (ev) => {
        if (ev.target.classList.contains('resize-handle') || ev.target.classList.contains('stamp-delete-button')) return;
        if (isPanMode) { ev.stopPropagation(); return; }
        selectStamp(newElement);
        startDrag(ev, newElement, container, false);
      });
      newElement.addEventListener('click', (ev) => {
         if (ev.target.classList.contains('stamp-delete-button')) return;
         selectStamp(newElement)
      });
      if (copiedStampData.type === 'text') {
        newElement.addEventListener('dblclick', (e) => { e.stopPropagation(); newElement.setAttribute("contenteditable", "true"); newElement.focus(); });
        newElement.addEventListener('blur', () => { newElement.removeAttribute("contenteditable"); saveHistory(); });
      }
      
      container.appendChild(newElement);
      if (!useCopiedCoordinates) {
        selectStamp(newElement);
      }
    }
  }

  // --- Fungsi Shape ---
  btnToggleShape.addEventListener('click', () => {
    isAddingShape = !isAddingShape;
    btnToggleShape.textContent = isAddingShape ? "Cancel Shape" : "Add Shape";
    btnToggleShape.classList.toggle('action-button-secondary');
    btnToggleShape.classList.toggle('action-button-primary');
  });
  shapeColorInput.addEventListener('input', () => {
    shapeColor = shapeColorInput.value;
    if (selectedStamp && selectedStamp.classList.contains('shape-element')) {
      selectedStamp.setAttribute('data-color', shapeColor);
      if (selectedStamp.getAttribute('data-shape') === 'line') {
        selectedStamp.style.borderTop = "2px solid " + shapeColor;
      } else {
        selectedStamp.style.background = shapeColor;
        if (selectedStamp.getAttribute('data-shape') === 'ellipse') {
          selectedStamp.style.borderRadius = "50%";
        }
      }
      saveHistory();
    }
  });
  shapeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      shapeButtons.forEach(b => b.classList.remove('active-btn'));
      btn.classList.add('active-btn');
      shapeType = btn.getAttribute('data-shape');
    });
  });
  
  pdfMain.addEventListener('mousedown', (e) => {
    if (!isAddingShape || isPanMode) return;
    if (e.target.closest('aside, .pdf-controls, #custom-context-menu, .stamp-container, .text-element, .shape-element, .timestamp-preview')) return;
    
    const container = e.target.closest('.preview-container');
    if (!container) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const rect = container.getBoundingClientRect();
    
    // --- PERBAIKAN KOORDINAT (4) ---
    // Menghapus `(currentTranslateX / currentZoom)` dan `(currentTranslateY / currentZoom)`
    shapeStartX = (e.clientX - rect.left) / currentZoom;
    shapeStartY = (e.clientY - rect.top) / currentZoom;
    
    tempShapeEl = document.createElement('div');
    tempShapeEl.className = "shape-element";
    tempShapeEl.style.border = "none";
    tempShapeEl.setAttribute('data-shape', shapeType);
    tempShapeEl.setAttribute('data-color', shapeColor);
    
    if (shapeType === 'line') {
      tempShapeEl.style.left = shapeStartX + "px";
      tempShapeEl.style.top = shapeStartY + "px";
      tempShapeEl.style.width = "0px";
      tempShapeEl.style.height = "2px";
      tempShapeEl.style.borderTop = "2px solid " + shapeColor;
      tempShapeEl.style.transformOrigin = "0 50%";
      tempShapeEl.dataset.thickness = "2";
    } else {
      tempShapeEl.style.left = shapeStartX + "px";
      tempShapeEl.style.top = shapeStartY + "px";
      tempShapeEl.style.width = "0px";
      tempShapeEl.style.height = "0px";
      tempShapeEl.style.background = shapeColor;
      if (shapeType === 'ellipse') {
        tempShapeEl.style.borderRadius = "50%";
      }
    }
    container.appendChild(tempShapeEl);

    const onShapeMouseMove = (eMove) => {
      if (!tempShapeEl || !isAddingShape) return;
      
      // --- PERBAIKAN KOORDINAT (5) ---
      // Menghapus `(currentTranslateX / currentZoom)` dan `(currentTranslateY / currentZoom)`
      const currentX = (eMove.clientX - rect.left) / currentZoom;
      const currentY = (eMove.clientY - rect.top) / currentZoom;
      
      if (tempShapeEl.getAttribute('data-shape') === 'line') {
        const dx = currentX - shapeStartX;
        const dy = currentY - shapeStartY;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * (180 / Math.PI);
        tempShapeEl.style.width = length + "px";
        tempShapeEl.style.transform = `rotate(${angle}deg)`;
        tempShapeEl.dataset.angle = angle;
      } else {
        const w = currentX - shapeStartX;
        const h = currentY - shapeStartY;
        tempShapeEl.style.left = (w < 0 ? currentX : shapeStartX) + "px";
        tempShapeEl.style.top = (h < 0 ? currentY : shapeStartY) + "px";
        tempShapeEl.style.width = Math.abs(w) + "px";
        tempShapeEl.style.height = Math.abs(h) + "px";
        if (tempShapeEl.getAttribute('data-shape') === 'ellipse') {
          tempShapeEl.style.borderRadius = "50%";
        }
      }
    };
    const onShapeMouseUp = (eUp) => {
      if (!tempShapeEl || !isAddingShape) return;
      
      let w = parseFloat(tempShapeEl.style.width);
      let h = parseFloat(tempShapeEl.style.height);
      if (tempShapeEl.getAttribute('data-shape') === 'line') {
        if (w < 10) { tempShapeEl.remove(); tempShapeEl = null; return; }
      } else {
        if (w < 10 || h < 10) { tempShapeEl.remove(); tempShapeEl = null; return; }
      }
      
      const finalizedShape = tempShapeEl;
      finalizedShape.style.border = "1px dashed var(--accent-start)";
      
      finalizedShape.addEventListener('click', () => selectStamp(finalizedShape));
      finalizedShape.addEventListener('mousedown', (ev) => {
        if (ev.target.classList.contains('resize-handle') || ev.target.classList.contains('stamp-delete-button')) return;
        if (isPanMode) { ev.stopPropagation(); return; }
        selectStamp(finalizedShape);
        startDrag(ev, finalizedShape, container, false);
      });
      
      const resizeHandle = document.createElement('div');
      resizeHandle.className = "resize-handle";
      finalizedShape.appendChild(resizeHandle);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = "stamp-delete-button";
      deleteBtn.textContent = "";
      deleteBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        finalizedShape.remove();
        saveHistory();
      });
      if (finalizedShape.getAttribute('data-shape') === 'line') {
        deleteBtn.style.transform = "rotate(" + (-parseFloat(finalizedShape.dataset.angle)) + "deg)";
      }
      finalizedShape.appendChild(deleteBtn);
      
      tempShapeEl = null;
      isAddingShape = false;
      btnToggleShape.textContent = "Add Shape";
      btnToggleShape.classList.add('action-button-secondary');
      btnToggleShape.classList.remove('action-button-primary');
      
      saveHistory();
      
      document.removeEventListener('mousemove', onShapeMouseMove);
      document.removeEventListener('mouseup', onShapeMouseUp);
    };

    document.addEventListener('mousemove', onShapeMouseMove);
    document.addEventListener('mouseup', onShapeMouseUp);
  });


  // --- Navigasi Halaman ---
  function goToPage(pageNumber) {
    if (pageNumber < 1) pageNumber = 1;
    if (pageNumber > totalPages) pageNumber = totalPages;
    currentPage = pageNumber;
    currentPageInput.value = currentPage;
    const targetPage = document.getElementById(`page-container-${pageNumber}`);
    if (targetPage) { 
      targetPage.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
      document.querySelectorAll('.preview-container').forEach(c => c.style.borderColor = 'var(--border-color)');
      targetPage.style.borderColor = 'var(--accent-start)';
      activeContainer = targetPage;
    }
  }
  btnPrevPage.addEventListener('click', () => { if (currentPage > 1) goToPage(currentPage - 1); });
  btnNextPage.addEventListener('click', () => { if (currentPage < totalPages) goToPage(currentPage + 1); });
  currentPageInput.addEventListener('change', (e) => {
    const requestedPage = parseInt(e.target.value);
    if (!isNaN(requestedPage)) { goToPage(requestedPage); }
  });

  /*********************** Download PDF ***********************/
  // REFAKTOR: Logika download dipisah ke fungsi sendiri
  async function executePdfDownload() {
    if (!pdfFile) { showToast("PDF belum di-preview.", "warning"); return; }
    
    const spinner = document.getElementById('mergeSpinner');
    spinner.classList.remove('hidden');
    btnDownload.disabled = true;

    try {
      const freshPdfData = await pdfFile.arrayBuffer();
      const pdfDocLib = await PDFLib.PDFDocument.load(freshPdfData);
      
      const fontMapping = {
        "Helvetica": {
          regular: PDFLib.StandardFonts.Helvetica,
          bold: PDFLib.StandardFonts.HelveticaBold,
          italic: PDFLib.StandardFonts.HelveticaOblique,
          boldItalic: PDFLib.StandardFonts.HelveticaBoldOblique
        },
        "Times Roman": {
          regular: PDFLib.StandardFonts.TimesRoman,
          bold: PDFLib.StandardFonts.TimesRomanBold,
          italic: PDFLib.StandardFonts.TimesRomanItalic,
          boldItalic: PDFLib.StandardFonts.TimesRomanBoldItalic
        },
        "Courier": {
          regular: PDFLib.StandardFonts.Courier,
          bold: PDFLib.StandardFonts.CourierBold,
          italic: PDFLib.StandardFonts.CourierOblique,
          boldItalic: PDFLib.StandardFonts.CourierBoldOblique
        },
        "Verdana": { 
          regular: PDFLib.StandardFonts.Helvetica,
          bold: PDFLib.StandardFonts.HelveticaBold,
          italic: PDFLib.StandardFonts.HelveticaOblique,
          boldItalic: PDFLib.StandardFonts.HelveticaBoldOblique
        }
      };
      const embeddedFontMapping = {};
      for (const family in fontMapping) {
        embeddedFontMapping[family] = {
          regular: await pdfDocLib.embedFont(fontMapping[family].regular),
          bold: await pdfDocLib.embedFont(fontMapping[family].bold),
          italic: await pdfDocLib.embedFont(fontMapping[family].italic),
          boldItalic: await pdfDocLib.embedFont(fontMapping[family].boldItalic)
        };
      }
      
      const containers = document.querySelectorAll(".preview-container");
      for (const container of containers) {
        const pageNumber = parseInt(container.getAttribute('data-page'));
        const scale = parseFloat(container.getAttribute('data-scale'));
        const originalHeight = parseFloat(container.getAttribute('data-original-height'));
        const pdfPage = pdfDocLib.getPages()[pageNumber - 1];
        
        const stamps = container.querySelectorAll(".stamp-container");
        for (const stamp of stamps) {
          const stampX = parseFloat(stamp.style.left) || 0;
          const stampY = parseFloat(stamp.style.top) || 0;
          const stampWidth = stamp.offsetWidth;
          const stampHeight = stamp.offsetHeight;
          const pdfX = stampX / scale;
          const pdfWidth = stampWidth / scale;
          const pdfHeight = stampHeight / scale;
          const pdfY = originalHeight - (stampY + stampHeight) / scale;
          const stampImgSrc = stamp.querySelector('img').src;
          let stampEmbed;
          if (stampImgSrc.startsWith("data:image/png")) {
            stampEmbed = await pdfDocLib.embedPng(stampImgSrc);
          } else if (stampImgSrc.startsWith("data:image/jpeg")) {
            stampEmbed = await pdfDocLib.embedJpg(stampImgSrc);
          } else { 
            showToast("Format gambar TTD tidak didukung.", "error"); 
            continue; 
          }
          pdfPage.drawImage(stampEmbed, { x: pdfX, y: pdfY, width: pdfWidth, height: pdfHeight });
        }
        
        const shapes = container.querySelectorAll(".shape-element");
        for (const shape of shapes) {
          const shapeX = parseFloat(shape.style.left) || 0;
          const shapeY = parseFloat(shape.style.top) || 0;
          const shapeWidth = shape.offsetWidth;
          const shapeHeight = shape.offsetHeight;
          const pdfX = shapeX / scale;
          const pdfWidth = shapeWidth / scale;
          const pdfHeight = shapeHeight / scale;
          const pdfY = originalHeight - (shapeY + shapeHeight) / scale;
          const shapeType = shape.getAttribute('data-shape');
          const shapeColorHex = shape.getAttribute('data-color') || "#000000";
          const color = hexToRgbNormalized(shapeColorHex);
          
          if (shapeType === "rectangle") {
            pdfPage.drawRectangle({
              x: pdfX,
              y: pdfY,
              width: pdfWidth,
              height: pdfHeight,
              color: color
            });
          } else if (shapeType === "ellipse") {
            pdfPage.drawEllipse({
              x: pdfX + pdfWidth / 2,
              y: pdfY + pdfHeight / 2,
              xScale: pdfWidth / 2,
              yScale: pdfHeight / 2,
              color: color
            });
          } else if (shapeType === "line") {
            const angle = parseFloat(shape.dataset.angle) || 0;
            const thickness = parseFloat(shape.dataset.thickness) || 2;
            const startX = pdfX;
            const startY = originalHeight - (shapeY / scale) - (shapeHeight / 2 / scale);
            const endX = startX + pdfWidth * Math.cos(angle * Math.PI / 180);
            const endY = startY + pdfWidth * Math.sin(angle * Math.PI / 180);
            pdfPage.drawLine({
              start: { x: startX, y: startY },
              end: { x: endX, y: endY },
              color: color,
              thickness: thickness
            });
          }
        }
        
        const texts = container.querySelectorAll(".text-element");
        for (const textEl of texts) {
          const text = textEl.innerText;
          const textX = parseFloat(textEl.style.left) || 0;
          const textY = parseFloat(textEl.style.top) || 0;
          const fontSize = parseFloat(textEl.style.fontSize) || 12;
          const pdfX = textX / scale;
          const pdfY = originalHeight - (textY / scale) - (fontSize / scale * 0.9);
          const fontFamily = textEl.style.fontFamily || "Helvetica";
          const color = hexToRgbNormalized(textEl.style.color || "#000000");
          let font;
          if (textEl.style.fontWeight === "bold" && textEl.style.fontStyle === "italic") {
            font = embeddedFontMapping[fontFamily].boldItalic;
          } else if (textEl.style.fontWeight === "bold") {
            font = embeddedFontMapping[fontFamily].bold;
          } else if (textEl.style.fontStyle === "italic") {
            font = embeddedFontMapping[fontFamily].italic;
          } else {
            font = embeddedFontMapping[fontFamily].regular;
          }
          const textAlign = textEl.style.textAlign || 'left';
          const isUnderlined = (textEl.style.textDecoration || '').includes('underline');
          const scaledFontSize = fontSize / scale;
          const textWidth = font.widthOfTextAtSize(text, scaledFontSize);
          const maxWidth = (textEl.offsetWidth / scale);
          
          let alignedPdfX = pdfX;
          if (textAlign === 'center') {
              alignedPdfX = pdfX + (maxWidth / 2) - (textWidth / 2);
          } else if (textAlign === 'right') {
              alignedPdfX = pdfX + maxWidth - textWidth;
          }

          pdfPage.drawText(text, {
            x: alignedPdfX,
            y: pdfY,
            size: scaledFontSize,
            font: font,
            color: color,
            lineHeight: (fontSize * 1.2) / scale,
            maxWidth: maxWidth,
            underline: isUnderlined,
          });
        }
        
        const timestamps = container.querySelectorAll(".timestamp-preview");
        timestamps.forEach(ts => {
          const tsX = parseFloat(ts.style.left) || 0;
          const tsY = parseFloat(ts.style.top) || 0;
          const tsText = ts.textContent;
          const pdfX = tsX / scale;
          const pdfY = originalHeight - (tsY / scale) - (8 / scale);
          pdfPage.drawText(tsText, {
            x: pdfX,
            y: pdfY,
            size: 8 / scale,
            font: embeddedFontMapping["Helvetica"].regular,
            color: PDFLib.rgb(0, 0, 0)
          });
        });
      }
      
      const modifiedPdfBytes = await pdfDocLib.save();
      const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = outputFileNameInput.value ? outputFileNameInput.value + '.pdf' : 'Modified_PDF.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast("PDF berhasil diunduh!", "success");
      
    } catch (error) {
      console.error("Download error:", error);
      showToast("Terjadi kesalahan saat mengunduh PDF.", "error");
    } finally {
      spinner.classList.add('hidden');
      btnDownload.disabled = false;
    }
  }

  // REFAKTOR: Listener download sekarang mengecek notifikasi
  btnDownload.addEventListener('click', async () => {
    if (showJiNotify) {
      openJiConfirmModal();
    } else {
      await executePdfDownload();
    }
  });

  // BARU: Listener untuk tombol "Sesuai" di modal JI
  jiConfirmSesuai.addEventListener('click', async () => {
    closeJiConfirmModal();
    await executePdfDownload();
  });


  /*********************** Fitur Drag & Drop File PDF ***********************/
  // PERUBAHAN: Ganti 'viewerContainer' ke 'mainContent'
  mainContent.addEventListener('dragover', (e) => {
    e.preventDefault();
    mainContent.classList.add('drag-over-active');
  });
  mainContent.addEventListener('dragleave', (e) => {
    mainContent.classList.remove('drag-over-active');
  });
  mainContent.addEventListener('drop', async (e) => {
    e.preventDefault();
    mainContent.classList.remove('drag-over-active');
    
    // PERUBAHAN: Cek drop di sidebar (sekarang <aside>)
    if (e.target.closest('aside')) {
      return;
    }

    if (e.dataTransfer.files.length > 0) {
      const droppedFile = e.dataTransfer.files[0];
      if (droppedFile.type === "application/pdf") {
        pdfFile = droppedFile;
        pdfData = await droppedFile.arrayBuffer();
        await renderPDF(pdfData); // renderPDF sudah diupdate
      } else {
        showToast("Silakan drop file PDF.", "warning");
      }
    }
  });

  // --- INISIALISASI ---
  loadSavedTheme();
  setupConstellationEffect();
  setupThemeEventListeners();
  updateUndoRedoButtons(); 

  // Listener untuk collapsible shapes
  const shapesHeader = document.getElementById('shapes-header');
  const shapesContent = document.getElementById('shapes-content');
  shapesHeader.addEventListener('click', () => {
    const isCollapsed = shapesContent.style.display === 'none';
    shapesContent.style.display = isCollapsed ? 'block' : 'none';
    shapesHeader.classList.toggle('collapsed', !isCollapsed);
  });
  
  // PERUBAHAN: Tambahkan animasi fade-in
  document.querySelectorAll('.initial-hidden').forEach((el, i) => setTimeout(() => {
      el.classList.add('animate-fade-in');
      el.classList.remove('initial-hidden');
  }, i * 200));

})();
</script>

</body>
</html>